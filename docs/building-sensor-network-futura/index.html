<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Building Sensor Network: Jablotron Futura integration  &middot; Lubolab</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="Personal DWH, Jablotron, Futura, Modbus2MQTT, ">


<meta property="og:title" content="Building Sensor Network: Jablotron Futura integration  &middot; Lubolab ">
<meta property="og:site_name" content="Lubolab"/>
<meta property="og:url" content="https://lubolab.com/building-sensor-network-futura/" />
<meta property="og:locale" content="en">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2018-02-09T03:57:28&#43;02:00" />
<meta property="og:article:modified_time" content="2018-02-09T03:57:28&#43;02:00" />

  
    
<meta property="og:article:tag" content="Personal DWH">
    
<meta property="og:article:tag" content="Jablotron">
    
<meta property="og:article:tag" content="Futura">
    
<meta property="og:article:tag" content="Modbus2MQTT">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@LubomirKamensky" />
<meta name="twitter:creator" content="@LubomirKamensky" />
<meta name="twitter:title" content="Building Sensor Network: Jablotron Futura integration" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://lubolab.com/building-sensor-network-futura/" />
<meta name="twitter:domain" content="https://lubolab.com/">
  

  



<link rel="canonical" href="https://lubolab.com/building-sensor-network-futura/" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://lubolab.com/touch-icon-144-precomposed.png">
<link rel="icon" href="https://lubolab.com/favicon.png">
<meta name="generator" content="Hugo 0.25.1" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="https://lubolab.com/css/bootswatch/paper/bootstrap.min.css">


<link rel="stylesheet" href="https://lubolab.com/css/font-awesome.min.css">
<link rel="stylesheet" href="https://lubolab.com/css/style.css">


<link rel="stylesheet" href="https://lubolab.com/css/style_custom.css">



  <link rel="stylesheet" href="https://lubolab.com/css/highlight/default.css">


</head>
<body class="map[name:paper]" data-ng-app="myapp" data-ng-controller="MyController" data-ng-mouseleave="MouseLeave($event)">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        
          
          <a class="navbar-brand-img" href="https://lubolab.com/">
            <img alt="Lubolab" src="https://lubolab.com/images/lubolablogo.png">
            
          </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            
            
            <li class="">

              <a href="https://datalab.lubolab.com/" >
                <i class='fa fa-flask'></i>
                Datalab
              </a>
            </li>
            
            <li class="">

              <a href="https://github.com/lubomirkamensky/lubolab" >
                <i class='fa fa-github'></i>
                Blog Source code
              </a>
            </li>
            
            <li class="">

              <a href="https://twitter.com/LubomirKamensky" >
                <i class='fa fa-twitter'></i>
                Twitter
              </a>
            </li>
            
            
              
          </ul>
        </div>
        
      </div>
    </nav>
  </header>


<div class="container">
  <div class="row">
    <div class="col-sm-9">
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <div class="text-center">

    <h1>Building Sensor Network: Jablotron Futura integration
</h1>

    <div class="metas">
<small>
  <i class="fa fa-calendar"></i>
  <time datetime="2018-02-09">9 Feb, 2018</time>
</small>


  <small>
  &middot; Read in about 5 min
  &middot; (866 words)
  &middot; 
<span class="share-box">Share this on:
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-facebook-official "></i></a>

    <a href="https://twitter.com/intent/tweet?text=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration&amp;url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-twitter"></i></a>

    <a href="https://plus.google.com/share?url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-google-plus"></i></a>

    <a href="http://www.reddit.com/submit?url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-reddit"></i></a>

    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f&amp;title=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-linkedin"></i></a>

    <a href="mailto:?subject=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration&amp;body=Check out this site https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" data-proofer-ignore=""><i class="fa fa-envelope"></i></a>
  </span>

  </small>

<div class="margin-10">
  <i class="fa fa-tags"></i>
  
  <a href="https://lubolab.com/tags/personal-dwh" class="label label-primary">Personal DWH</a>
  
  <a href="https://lubolab.com/tags/jablotron" class="label label-primary">Jablotron</a>
  
  <a href="https://lubolab.com/tags/futura" class="label label-primary">Futura</a>
  
  <a href="https://lubolab.com/tags/modbus2mqtt" class="label label-primary">Modbus2MQTT</a>
  


</div>

<br>
</div>

  </div>
</div>

      <div class="content">
  

<h3 id="jablotron-futura">Jablotron Futura</h3>

<p><a href="https://rekuperace.jablotron.cz/en" target="_blank">Futura</a> is a heat recovery unit, sort of the heart of a house ventilation system and as such, it can introduce complex information about the indoor air quality into my sensor network. But to be honest that fact wasn&rsquo;t the main driver for its integration.</p>

<h3 id="the-driver">The driver</h3>

<p>It was one issue I had with the unit and couldn&rsquo;t fix it within the standard product support. The behavior of the units depends on the settings you give it. The most important value is the required temperature.</p>

<p>I am afraid there is a quite naive idea that if you set the optimal temperature, then the main requirement is to keep such temperature exactly and strictly on that level at any point in time. That is definitely far away from the reality.</p>

<div class="c_alert c_alert-success"> 
Functional heat recovery unit should think ahead a bit. So during a hot summer if the temperature during the night falls below the required level it shouldn't start recovering the heat to keep the exact required temperature. It would be definitely wasting the perfect opportunity to cool the house a bit before the hot day comes again.

And similarly for the cold winter. If we light our fireplace and the indoor temperature goes above the required level, we don't want the unit to start bypass mode immediately and waste the expensive heat.
</div>

<p>Of course it is possible to always shift the required temperature in the mobile app, but honestly, that is a task for the machine not for creative human being.</p>

<p>Fortunately, the solution is easy, just to set the required temperature way above the optimal in winter and way below the optimal in summer. Then everything works exactly how it should.</p>

<p>Now we are finally getting close to the issue I had. Unfortunately, some of the settings get lost whenever the heat recovery unit  disconnects from the power supply. And the required temperature is one of them so it resets to the default value 21 degrees. Consulting this issue with product support, they say the unit should keep all the setting, but so far they cannot find out why it is not so.</p>

<h3 id="the-idea">The idea</h3>

<p>The good thing I learned from the support guy was that it is possible to communicate directly with the unit through Modbus TCP protocol. That new fact opened completely new direction in my thinking. There is no reason to have all the equipment in the house extra intelligent, it is perfectly enough if they can just collaborate with something smarter than they are.</p>

<h3 id="futura-integration">Futura integration</h3>

<p>I already revealed the idea of sensor network access layers in the <a href="https://lubolab.com/building-sensor-network-bc/">first post</a> of Building Sensor Network series.</p>

<p>The main idea is to avoid the Babylon syndrom and unify the communication between all the devices in the sensor network.</p>

<p>We need to teach Futura to communicate over MQTT. And to keep thing simple, using the similar approach as for BigCLown modules. Introducing another translation gate, this time for Modbus protocol.</p>

<h3 id="modbus-to-mqtt-gate">Modbus to MQTT gate</h3>

<p>I think we live in amazing times when the human knowledge is shared over the internet and it is just matter of minutes to gather enough information to solve most of the tasks we can face. Sharing the source code moves it even further. Not surprisingly, I wasn&rsquo;t the first one having the idea of translation gate between Modbus and MQTT protocols.</p>

<p>There was already <a href="https://github.com/owagner/modbus2mqtt" target="_blank">modbus2mqtt</a> from Oliver Wagner. I tried to use it as it was but without much success, so I made <a href="https://github.com/lubomirkamensky/modbus2mqtt" target="_blank">my own fork</a> and dug in a bit. There were just few compatibility issues related to latest Python and involved libraries.  The biggest task was to create <a href="https://github.com/lubomirkamensky/modbus2mqtt/blob/master/futura.csv" target="_blank">register definition</a> file for the Futura.</p>

<div class="c_alert c_alert-success">
I got Modbus register documentation for Futura from Jablotron support. And after some experiments started to understand how it all works. The <a href="https://github.com/lubomirkamensky/modbus2mqtt/blob/master/futura.csv" target="new">register definition</a> file defines what data available through Modbus we publish over MQTT. For each attribute we need to specify following information: "Topic", "Register", "Size", "Format", "Frequency", "Slave", "FunctionCode"
</div>

<p>Supporting our laziness, it allows defining defaults for constant values.
For our purpose, we define two big groups of attributes, one for Input registers, one for Holding registers.  Specification of each group starts with default definition specifying everything but the first two values.</p>

<p>Then for any  attribute, we specify just the MQTT topic and position in Modbus Registers. There is just one difference between the groups. The FunctionCode 4  for Input registers and FunctionCode 3 for Holding registers. See the shortened version of the <a href="https://github.com/lubomirkamensky/modbus2mqtt/blob/master/futura.csv" target="_blank">register definition</a> below.</p>

<pre><code># Input Registers 
DEFAULT,,1,&gt;H:,15,1,4
# 
temp_ambient,15
temp_fresh,16
temp_indoor,17
temp_waste,18
rh_ambient,19
# 
# Holding Registers 
DEFAULT,,1,&gt;H:,15,1,3
# 
fventilation,0
boost_tm,1
circulation_tm,2
overpressure_tm,3
night_tm,4
</code></pre>

<p>Having the register definition file in place, we can test how it works:</p>

<pre><code>python3 modbus2mqtt.py --mqtt-topic futura --tcp HOST_IP --registers futura.csv
</code></pre>

<p>and in the second terminal subscribe to the Futura messages:</p>

<pre><code>mosquitto_sub -v -t 'futura/#'
</code></pre>

<p>And you should see something like this:</p>

<p><img src="https://lubolab.com/images/2018/02/futura.png" alt="The Matrix" /></p>

<p>Then the final step is to set this new Python gate as another pm2 process.</p>

<pre><code>pm2 start /usr/bin/python3 --name &quot;json2mqtt-neurio&quot; -- /home/luba/Git/modbus2mqtt/modbus2mqtt.py --mqtt-topic futura --tcp HOST_IP --registers /home/luba/Git/modbus2mqtt/futura.csv
pm2 save
</code></pre>

<h3 id="update-modbus-tcp2mqtt">Update - modbus-tcp2mqtt</h3>

<p>Later I was facing some additional requirements for changes and decided to create my own simple gate <a href="https://github.com/lubomirkamensky/modbus-tcp2mqtt" target="_blank">modbus-tcp2mqtt</a>.</p>

</div>


      <footer>
  
<span class="share-box">Share this on:
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-facebook-official "></i></a>

    <a href="https://twitter.com/intent/tweet?text=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration&amp;url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-twitter"></i></a>

    <a href="https://plus.google.com/share?url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-google-plus"></i></a>

    <a href="http://www.reddit.com/submit?url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-reddit"></i></a>

    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f&amp;title=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration" onclick="window.open(this.href, 'mywin',
'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"><i class="fa fa-linkedin"></i></a>

    <a href="mailto:?subject=Building%20Sensor%20Network%3a%20Jablotron%20Futura%20integration&amp;body=Check out this site https%3a%2f%2flubolab.com%2fbuilding-sensor-network-futura%2f" data-proofer-ignore=""><i class="fa fa-envelope"></i></a>
  </span>

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      
  
    <nav><ul class="pager">
    
        <li class="previous">
          <a href="https://lubolab.com/iot-doorbell-bc/" title="IoT Doorbell: with BigClown">
            <span aria-hidden="true">&larr;</span>Previous
          </a>
        </li>
    

    
      <li class="next">
        <a href="https://lubolab.com/building-sensor-network-neurio/" title="Building Sensor Network: Neurio integration">
            Next <span aria-hidden="true">&rarr;</span>
        </a>
      </li>
    
    </ul> </nav>
  


</div>

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//lubolab.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

</footer>

    </div>
    
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <div>
  

    <div class="section">
      <header><div class="title"><b>Latest Posts</b></div></header>
      <div class="content">
        <ul>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-grafana/">Building Sensor Network: Data visualisation with Grafana</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-history/">Building Sensor Network: History layer using InfluxData</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-sms/">Building Sensor Network: SMS gateway, Node-RED and smart alerts</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-battery/">Building Sensor Network: Computer Battery Monitor</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-neurio/">Building Sensor Network: Neurio integration</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-futura/">Building Sensor Network: Jablotron Futura integration</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/iot-doorbell-bc/">IoT Doorbell: with BigClown</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/building-sensor-network-bc/">Building Sensor Network: with BigClown</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/camera-events-the-etl/">Camera Events: The ETL</a>
          </li>
        
          <li>
          <a href="https://lubolab.com/camera-events-data-model/">Camera Events: Data Model</a>
          </li>
        
        </ul>
      </div>
    </div>

    
      
      
    
      
      
      <div class="section taxonomies">
        <header><div class="title"><b>tag</b></div></header>

        <div class="content">
          <ul>
            <li><a href="https://lubolab.com/tags/personal-dwh">personal-dwh</a></li><li><a href="https://lubolab.com/tags/bigclown">bigclown</a></li><li><a href="https://lubolab.com/tags/netatmo">netatmo</a></li><li><a href="https://lubolab.com/tags/battery-monitor2mqtt">battery-monitor2mqtt</a></li><li><a href="https://lubolab.com/tags/blogging-platform">blogging-platform</a></li><li><a href="https://lubolab.com/tags/futura">futura</a></li><li><a href="https://lubolab.com/tags/grafana">grafana</a></li><li><a href="https://lubolab.com/tags/influxdata">influxdata</a></li><li><a href="https://lubolab.com/tags/jablotron">jablotron</a></li><li><a href="https://lubolab.com/tags/json2mqtt">json2mqtt</a></li>
          </ul>
        </div>
      </div>
      
    
      
      
    

</div>

      </div>
    
  </div>
</div>
    
<footer class="footer hidden-print">
  <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="javascript:" id="return-to-top">back to top</a>
</div>
<div class="pull-right">

<a href="https://lubolab.com/"></a> <i>&middot;</i>

</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
              
    

    
<div class="container copyright">
    <small>
  &copy; 2018 Lubolab

  </small>
</div>



        </div>
    </div>
  </div>
</footer>

    

<script src="https://lubolab.com/js/jquery.min.js"></script>
<script src="https://lubolab.com/js/bootstrap.min.js"></script>


<script src="https://lubolab.com/js/highlight.pack.js"></script>
<script src="https://lubolab.com/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
  var _gaq=[['_setAccount','UA-90639023-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<script>
var ENABLE_POPOVER =  false , 
EXPIRE_COOKIE =  5 , 
SHOW_MODAL_TIMEOUT =  10000 , 
MOUSE_LEAVE =  true , 
MODAL_SIZE = "", 
POST_URL = "https://zapier.com/hooks/catch/1227563/", 
SIGNUP_HEADER = "Join Our Newsletter",
HEADER_IMAGE = "//placehold.it/1000x600",
IMG_DESCRIPTION = "Placeholder image for this popover modal optin form",
SIGNUP_TEXT = "Signup today for free and be the first to get notified on new updates.",
INPUT_PLACEHOLDER = "Enter your email",
SUBMIT_BUTTON = "Subscribe",
SUCCESS_MESSAGE = "Thanks for your subscription!",
ERROR_MESSAGE = "Submitting form failed!",
OPTIN =  true ,
COOKIE_NAME = "mycookie1",
CONTENTLANGUAGE = ""; 
</script>





<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/config/TeX-AMS-MML_HTMLorMML.js"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    for(var all in MathJax.Hub.getAllJax()) {
        all.SourceElement().parentNode.className += ' has-jax';

    }
});
</script>






  </body>
</html>

